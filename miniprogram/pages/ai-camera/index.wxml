<page-meta page-style="background: #E6E6E6;">
  <navigation-bar
    title="拍照识文物"
    back="{{true}}"
    color="black"
    background="#E6E6E6"
    styleType="dark"
  >
    <!-- <view slot="right" class="flash-button" bindtap="handleToggleFlash">
      <text class="flash-icon">⚡</text>
      <text class="flash-label">{{flashModeLabel}}</text>
    </view> -->
  </navigation-bar>

  <view class="ai-camera-page">
    <view class="preview-area">
      <!-- <image class="preview-image" src="{{previewImage}}" mode="aspectFill"></image> -->
      <view wx:if="{{isRecognizing}}" class="recognizing-overlay">
        <view class="recognize-visual">
          <image class="recognize-bg" src="{{previewImage}}" mode="aspectFit"></image>
          <view class="recognize-frame">
            <view class="recognize-corner top-left"></view>
            <view class="recognize-corner top-right"></view>
            <view class="recognize-corner bottom-left"></view>
            <view class="recognize-corner bottom-right"></view>
            <view class="recognize-scan-line"></view>
          </view>
          <text class="recognize-hint">AI 正在识别这件宝物，请稍候…</text>
        </view>
      </view>
     
      <view class="search-result" wx:if="{{showResultPage && exhibitDetail}}">
        <view class="search-result-scroll">
          <view class="result-hero">
            <view class="result-title">{{exhibitDetail.name}}</view>
            <view class="result-other" bindtap="handleOpenOtherResults">识别内容不准确？查看其他结果 ></view>
            <view class="result-image-wrap">
              <image class="result-image" src="{{exhibitDetail.image_url}}" mode="aspectFit"></image>
              <view wx:if="{{bubbles.length}}" class="bubble-layer">
                <block wx:for="{{bubbles}}" wx:key="title">
                  <view
                    class="bubble-item bubble-item-{{index}}"
                    bindtap="handleBubbleTap"
                    data-index="{{index}}"
                  >
                    <view class="bubble-icon">{{item.emoji}}</view>
                    <view class="bubble-text">{{item.title}}</view>
                  </view>
                </block>
              </view>
            </view>
            
          </view>
          <view wx:if="{{bubbleDetailVisible}}" class="bubble-detail-overlay">
            <view class="bubble-detail-mask" bindtap="closeBubbleDetail"></view>
            <view class="bubble-detail-sheet">
              <view class="bubble-detail-card">
                <view class="bubble-detail-close" bindtap="closeBubbleDetail">×</view>
                <view class="bubble-detail-title">
                  {{bubbleDetailTitle || '正在生成问题详情...'}}
                </view>
                <view class="bubble-detail-text">
                  {{bubbleDetailText || (bubbleDetailLoading ? '正在生成内容...' : '')}}
                </view>
              </view>
            </view>
          </view>
          <view wx:if="{{showOtherResults}}" class="other-results-overlay">
            <view class="other-results-mask" bindtap="closeOtherResults"></view>
            <view class="other-results-sheet">
              <view class="other-results-header">
                <view class="other-results-title">请选择识别结果</view>
                <view class="other-results-close" bindtap="closeOtherResults">×</view>
              </view>
              <view class="other-results-list">
                <block wx:for="{{otherResults}}" wx:key="image_id">
                  <view class="other-result-card" bindtap="handleSelectOtherResult" data-index="{{index}}">
                    <image class="other-result-image" src="{{item.image_url}}" mode="aspectFill"></image>
                    <view class="other-result-body">
                      <view class="other-result-name">{{item.name}}</view>
                      <view class="other-result-meta">
                        {{item.museum || '博物馆'}}·展厅·单元
                      </view>
                    </view>
                    <view class="other-result-score">匹配度{{item.scorePercent}}%</view>
                  </view>
                </block>
              </view>
            </view>
          </view>
          <view wx:if="{{showMatchScore}}" class="match-score">匹配分数：{{exhibitDetail.score}}</view>
          <view wx:if="{{exhibitDetail.content}}" class="result-section">
            <view class="title-group" style="background-image: url('https://bowudaoyu-public.oss-cn-beijing.aliyuncs.com/storage/user/image/mingpian_title.png')">
              <!-- <view class="section-title {{dailyListenExhibit? 'long': 'short'}}">
                <text>文物名片</text>
                <view class="audio-section" wx:if="{{dailyListenExhibit}}">
                  <listen-simple
                    title=""
                    exhibition="{{dailyListenExhibit}}"
                    bindPlayDailyListen="handlePlayDailyListen"
                    id="dailyListenPlayer"
                  ></listen-simple>
                </view>
              </view>
              <image
                class="section-title-border"
                src="/static/images/border.png"
                mode="scaleToFill"
              ></image> -->
            </view>
            <view class="content-group" style="background-image: url('https://bowudaoyu-public.oss-cn-beijing.aliyuncs.com/storage/user/image/mingpian_bg.jpg')">
              <view class="section-desc">{{exhibitDetail.content}}</view>
             
            </view>
            
          </view>
          
          <!-- <view class="result-footer">
            <text>识别内容不准确？欢迎</text>
            <text class="footer-link" bindtap="handleOpenMore">拍摄展签</text>
            <text>反馈</text>
          </view> -->
           
        </view>
        <!-- <view class="exhibit-action-row">
          <view class="action-buttons">
            <view class="exhibit-btn primary" bindtap="handleCloseExhibitOverlay">
              <text>不准确</text>
            </view>
            <view class="exhibit-btn primary" bindtap="handleConfirmExhibit">
              <text>结果正确</text>
            </view>
          </view>
        </view> -->
      </view>
      <view class="fankui-area" wx:if="{{showFeedbackForm}}">
        <scroll-view scroll-y="{{true}}" class="fankui-scroll">
          <view class="fankui-title">记录「考古」，分享给更多岛民</view>
          <image class="fankui-preview" src="{{exhibitDetail.image_url || previewImage}}" mode="aspectFit"></image>
          <view class="fankui-textbox">
            <textarea
              class="fankui-textarea"
              placeholder="写点鉴定依据吧～我们会更快的丰富藏宝库..."
              placeholder-class="fankui-placeholder"
              value="{{feedbackText}}"
              bindinput="handleFeedbackInput"
              maxlength="500"
            ></textarea>
            <view class="fankui-upload-list">
              <block wx:for="{{feedbackImages}}" wx:key="*this">
                <view class="upload-thumb">
                  <image src="{{item}}" mode="aspectFill"></image>
                  <view class="upload-remove" bindtap="handleRemoveFeedbackImage" data-index="{{index}}">×</view>
                </view>
              </block>
              <view class="upload-add" bindtap="handleAddFeedbackImage">
                <text class="upload-add-plus">+</text>
                <text class="upload-add-label">拍摄展签</text>
              </view>
            </view>
          </view>
          <view class="feedback-btnlist">
            <view class="feedback-cancel-btn" bindtap="handleCancelFeedback">取消</view>
            <view
            class="feedback-submit-btn"
            bindtap="handleSubmitFeedback"
            loading="{{submittingFeedback}}"
            disabled="{{submittingFeedback}}"
          >
            生成鉴定反馈
          </view>

          </view>
        </scroll-view>
      </view>
      <view wx:if="{{showFeedbackSuccessOverlay}}" class="feedback-success-overlay">
        <view class="feedback-success-card">
          <image
            class="feedback-success-image"
            src="/static/images/airobot.png"
            mode="aspectFit"
          ></image>
          <text class="feedback-success-title">已将鉴定请求发送给博物岛屿平台，努力丰富宝藏库中，谢谢理解～</text>
          <view
            class="feedback-success-button"
            bindtap="handleFeedbackSuccessReturn"
          >
            返回
          </view>
        </view>
      </view>
      <canvas
        canvas-id="compressCanvas"
        width="{{compressCanvasWidth}}"
        height="{{compressCanvasHeight}}"
        style="width: {{compressCanvasWidth}}px; height: {{compressCanvasHeight}}px; position: absolute; left: -9999px; top: -9999px;"
      ></canvas>
    </view>
  </view>
  <custom-tab-bar></custom-tab-bar>
</page-meta>
