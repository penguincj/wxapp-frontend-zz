<page-meta page-style="background: #242424;">
  <navigation-bar
    title="AI识别文物"
    back="{{true}}"
    color="white"
    background="#242424"
    styleType="light"
  >
    <!-- <view slot="right" class="flash-button" bindtap="handleToggleFlash">
      <text class="flash-icon">⚡</text>
      <text class="flash-label">{{flashModeLabel}}</text>
    </view> -->
  </navigation-bar>

  <view class="ai-camera-page">
      <view class="preview-area">
      <!-- <image class="preview-image" src="{{previewImage}}" mode="aspectFill"></image> -->
      <view wx:if="{{isRecognizing}}" class="recognizing-overlay">
        <view class="recognize-visual">
          <image class="recognize-bg" src="{{previewImage}}" mode="aspectFit" bindtap="handlePreviewImage" data-image-url="{{previewImage}}"></image>
          <view class="recognize-frame">
            <view class="recognize-corner top-left"></view>
            <view class="recognize-corner top-right"></view>
            <view class="recognize-corner bottom-left"></view>
            <view class="recognize-corner bottom-right"></view>
            <view class="recognize-scan-line"></view>
          </view>
          <text class="recognize-hint">AI 正在识别这件宝物，请稍候…</text>
        </view>
      </view>
     
      <view class="search-result" wx:if="{{showResultPage && artifactList.length}}">
        <view class="search-result-scroll">
          <view class="result-hero" wx:if="{{exhibitDetail}}">
            <view class="img-group">
              <view class="img-match-item">
                <view class="img-title">原图</view>
                <image class="result-image user-photo" src="{{exhibitDetail.user_image_url}}" mode="aspectFit" bindtap="handlePreviewImage" data-image-url="{{exhibitDetail.user_image_url}}"></image>
              </view>
              <view class="img-match-item">
                <view class="img-title">抠图</view>
                <image class="result-image cut-photo" src="{{exhibitDetail.cutout_image_url}}" mode="aspectFit" bindtap="handlePreviewImage" data-image-url="{{exhibitDetail.cutout_image_url}}"></image>
              </view>
              <view class="img-match-item">
                <view class="img-title">匹配图</view>
              <image class="result-image" src="{{exhibitDetail.image_url}}" mode="aspectFit" bindtap="handlePreviewImage" data-image-url="{{exhibitDetail.image_url}}"></image>
              </view>
            </view>
            
            <view class="result-title">{{exhibitDetail.name}}</view>
            
          </view>
          <view class="match-score">匹配分数：{{exhibitDetail.score}}</view>
          <view class="artifact-card-source" wx:if="{{exhibitDetail.source}}">来源：{{exhibitDetail.source}}</view>

          <view wx:if="{{exhibitDetail.content}}" class="result-section">
            <!-- <view class="title-group">
              <view class="section-title {{dailyListenExhibit? 'long': 'short'}}">
                <text>文物名片</text>
                <view class="audio-section" wx:if="{{dailyListenExhibit}}">
                  <listen-simple
                    title=""
                    exhibition="{{dailyListenExhibit}}"
                    bindPlayDailyListen="handlePlayDailyListen"
                    id="dailyListenPlayer"
                  ></listen-simple>
                </view>
              </view>
              <image
                class="section-title-border"
                src="/static/images/border.png"
                mode="scaleToFill"
              ></image>
            </view> -->
            <view class="content-group">
              <view class="section-desc">{{exhibitDetail.content}}</view>
             
            </view>
            
          </view>
          <view class="more-results" wx:if="{{artifactList.length > 1}}">
            <view class="more-results-title">更多匹配结果</view>
            <block wx:for="{{artifactList}}" wx:key="artifact_id" wx:for-index="index">
              <view wx:if="{{index !== 0}}" class="artifact-card">
                <image class="artifact-card-image" src="{{item.image_url}}" mode="aspectFit" bindtap="handlePreviewImage" data-image-url="{{item.image_url}}"></image>
                <view class="artifact-card-info">
                  <view class="artifact-card-title-row">
                    <text class="artifact-card-title">{{item.name}}</text>
                    <text wx:if="{{ item.score}}" class="match-score">匹配分数：{{item.score}}</text>
                  </view>
                  <view class="artifact-card-meta">
                    {{item.dynasty}}{{item.dynasty && item.museum ? ' · ' : ''}}{{item.museum}}
                  </view>
                  <view class="artifact-card-desc">{{item.description}}</view>
                  <view class="artifact-card-source" wx:if="{{item.source}}">来源：{{item.source}}</view>
                </view>
              </view>
            </block>
          </view>
          
          <!-- <view class="result-footer">
            <text>识别内容不准确？欢迎</text>
            <text>反馈</text>
          </view> -->
           
       </view>
        <view class="exhibit-action-row">
          <view class="action-buttons">
            <!-- <view class="exhibit-btn primary" bindtap="handleCloseExhibitOverlay">
              <text>不准确</text>
            </view> -->
            <view class="exhibit-btn primary" bindtap="handleConfirmExhibitFeedback">
              <text>反馈上报</text>
            </view>
          </view>
        </view>
      </view>
      <view class="fankui-area" wx:if="{{showFeedbackForm}}">
        <scroll-view scroll-y="{{true}}" class="fankui-scroll">
          <view class="fankui-title">记录「考古」，分享给更多岛民</view>
          <image class="fankui-preview" src="{{exhibitDetail.image_url || previewImage}}" mode="aspectFit" bindtap="handlePreviewImage" data-image-url="{{exhibitDetail.image_url || previewImage}}"></image>
          <view class="fankui-textbox">
            <textarea
              class="fankui-textarea"
              placeholder="写点鉴定依据吧～我们会更快的丰富藏宝库..."
              placeholder-class="fankui-placeholder"
              value="{{feedbackText}}"
              bindinput="handleFeedbackInput"
              maxlength="500"
            ></textarea>
            <view class="fankui-upload-list">
              <block wx:for="{{feedbackImages}}" wx:key="*this">
                <view class="upload-thumb">
                  <image src="{{item}}" mode="aspectFill" bindtap="handlePreviewImage" data-image-url="{{item}}"></image>
                  <view class="upload-remove" bindtap="handleRemoveFeedbackImage" data-index="{{index}}">×</view>
                </view>
              </block>
              <view class="upload-add" bindtap="handleAddFeedbackImage">
                <text class="upload-add-plus">+</text>
                <text class="upload-add-label">拍摄展签</text>
              </view>
            </view>
          </view>
          <view class="feedback-btnlist">
            <view class="feedback-cancel-btn" bindtap="handleCancelFeedback">取消</view>
            <view
            class="feedback-submit-btn"
            bindtap="handleSubmitFeedback"
            loading="{{submittingFeedback}}"
            disabled="{{submittingFeedback}}"
          >
            生成鉴定反馈
          </view>

          </view>
        </scroll-view>
      </view>
      <view wx:if="{{showFeedbackSuccessOverlay}}" class="feedback-success-overlay">
        <view class="feedback-success-card">
          <image
            class="feedback-success-image"
            src="/static/images/airobot.png"
            mode="aspectFit"
            bindtap="handlePreviewImage"
            data-image-url="/static/images/airobot.png"
          ></image>
          <text class="feedback-success-title">已将鉴定请求发送给博物岛屿平台，努力丰富宝藏库中，谢谢理解～</text>
          <view
            class="feedback-success-button"
            bindtap="handleFeedbackSuccessReturn"
          >
            返回
          </view>
        </view>
      </view>
      <view class="feedback-modal-overlay" wx:if="{{feedbackModalVisible}}">
        <view class="feedback-modal">
          <view class="feedback-modal-header">
            <text class="feedback-modal-title">结果上报</text>
            <text class="feedback-modal-close" bindtap="handleCancelFeedbackModal">×</text>
          </view>
          <view class="feedback-modal-section">
            <text class="feedback-modal-label">是否匹配</text>
            <view class="feedback-match-toggle">
              <view
                class="feedback-match-option {{feedbackModalIsMatch === 1 ? 'selected' : ''}}"
                data-value="1"
                bindtap="handleFeedbackModalToggleMatch"
              >
                <text>匹配</text>
              </view>
              <view
                class="feedback-match-option {{feedbackModalIsMatch === 0 ? 'selected' : ''}}"
                data-value="0"
                bindtap="handleFeedbackModalToggleMatch"
              >
                <text>不匹配</text>
              </view>
            </view>
          </view>
          <view class="feedback-modal-section" wx:if="{{feedbackModalIsMatch === 1 && artifactList.length}}">
            <text class="feedback-modal-label">选择匹配的文物</text>
            <view class="feedback-match-list">
              <block wx:for="{{artifactList}}" wx:key="artifact_id">
                <view
                  class="feedback-match-item {{feedbackModalMatchedId === item.image_id ? 'selected' : ''}}"
                  data-id="{{item.image_id}}"
                  bindtap="handleFeedbackModalSelectArtifact"
                >
                  <text class="feedback-match-item-name">{{item.name}}</text>
                  <text class="feedback-match-item-meta">{{item.dynasty}}{{item.dynasty && item.museum ? ' · ' : ''}}{{item.museum}}</text>
                  <text class="feedback-match-item-score">，分数：{{item.score}}</text>
                </view>
              </block>
            </view>
          </view>
          <view class="feedback-modal-section">
            <text class="feedback-modal-label">补充描述</text>
            <textarea
              class="feedback-modal-textarea"
              placeholder="补充你对识别结果的说明（选填）"
              value="{{feedbackModalContent}}"
              bindinput="handleFeedbackModalInput"
              maxlength="500"
            ></textarea>
          </view>
          <view class="feedback-modal-actions">
            <view class="feedback-modal-cancel" bindtap="handleCancelFeedbackModal">取消</view>
            <view
              class="feedback-modal-submit"
              bindtap="handleSubmitFeedbackReport"
              loading="{{feedbackModalSubmitting}}"
              disabled="{{feedbackModalSubmitting}}"
            >
              提交上报
            </view>
          </view>
        </view>
      </view>
    </view>

  </view>

  <custom-tab-bar></custom-tab-bar>
</page-meta>
